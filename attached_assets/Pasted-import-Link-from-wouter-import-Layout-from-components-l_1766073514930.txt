import { Link } from "wouter";
import { Layout } from "@/components/layout/Layout";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { useToast } from "@/hooks/use-toast";
import { Plus, Trash2, Building2 } from "lucide-react";
import { useData } from "@/lib/store";
import { useState, useEffect } from "react";

/* ===== ONLY ADDED CONSTANTS ===== */
const UNIT_OPTIONS = ["pcs", "kg", "meter", "sqft", "cum", "litre"];
const CATEGORY_OPTIONS = ["Civil", "Plumbing", "Electrical", "Tiles", "Doors", "Paint"];
const SUB_CATEGORY_OPTIONS: Record<string, string[]> = {
  Civil: ["Cement", "Sand", "Aggregate"],
  Plumbing: ["Pipes", "Valves", "Fittings"],
  Electrical: ["Wires", "Switches", "Lights"],
  Tiles: ["Floor Tiles", "Wall Tiles"],
  Doors: ["Flush Door", "Fire Door"],
  Paint: ["Primer", "Emulsion"]
};

export default function AdminDashboard() {
  const { toast } = useToast();
  const { shops, materials, addShop, addMaterial } = useData();

  /* ===== STEP 4: LOAD DB DATA ON REFRESH ===== */
  useEffect(() => {
    fetch("/api/shops")
      .then(res => res.json())
      .then(data => data.forEach((s: any) => addShop(s)))
      .catch(err => console.error("Failed to load shops:", err));

    fetch("/api/materials")
      .then(res => res.json())
      .then(data => data.forEach((m: any) => addMaterial(m)))
      .catch(err => console.error("Failed to load materials:", err));
  }, []);

  const [newShop, setNewShop] = useState({
    name: "",
    location: "",
    phone: "",
    city: "",
    state: "",
    country: "",
    pincode: ""
  });

  const [newMaterial, setNewMaterial] = useState({
    name: "",
    code: "",
    rate: "",
    shopId: "",
    unit: "pcs",
    category: "Civil",
    brandName: "",
    modelNumber: "",
    subCategory: "",
    technicalSpecification: "",
    image: null as File | null
  });

  /* ===== UPDATED HANDLERS ===== */
  const handleAddShop = async () => {
    if (!newShop.name) return;

    try {
      const res = await fetch("http://localhost:5000/api/shops", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newShop),
      });

      if (!res.ok) throw new Error("Failed to add shop");
      const savedShop = await res.json();

      addShop(savedShop); // Add returned shop to state

      setNewShop({
        name: "",
        location: "",
        phone: "",
        city: "",
        state: "",
        country: "",
        pincode: ""
      });

      toast({ title: "Success", description: "Shop added successfully" });
    } catch (err) {
      console.error(err);
      toast({ title: "Error", description: "Shop could not be added" });
    }
  };

 const handleAddMaterial = async () => {
  if (!newMaterial.name || !newMaterial.rate || !newMaterial.shopId) return;

  try {
    const formData = new FormData();
    formData.append("name", newMaterial.name);
    formData.append("code", newMaterial.code);
    formData.append("price", newMaterial.rate.toString());       // rate → price
    formData.append("shop_id", newMaterial.shopId.toString());   // shopId → shop_id
    formData.append("unit", newMaterial.unit);
    formData.append("category", newMaterial.category);
    formData.append("brand_name", newMaterial.brandName);        // brandName → brand_name
    formData.append("model_number", newMaterial.modelNumber);    // modelNumber → model_number
    formData.append("sub_category", newMaterial.subCategory);    // subCategory → sub_category
    formData.append("technical_specification", newMaterial.technicalSpecification); // technicalSpecification → technical_specification
    if (newMaterial.image) {
      formData.append("image", newMaterial.image);
    }

    const res = await fetch("http://localhost:5000/api/materials", {
      method: "POST",
      body: formData,
    });

    if (!res.ok) throw new Error("Failed to add material");
    const savedMaterial = await res.json();
    addMaterial(savedMaterial);

    setNewMaterial({
      name: "",
      code: "",
      rate: "",
      shopId: "",
      unit: "pcs",
      category: "Civil",
      brandName: "",
      modelNumber: "",
      subCategory: "",
      technicalSpecification: "",
      image: null
    });

    toast({ title: "Success", description: "Material added successfully" });
  } catch (err) {
    console.error(err);
    toast({ title: "Error", description: "Material could not be added" });
  }
};


  /* ===== RENDER UI (UNCHANGED) ===== */
  return (
    <Layout>
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold tracking-tight font-display text-primary">
            Admin Dashboard
          </h2>
          <p className="text-muted-foreground">
            Manage organizations, shops, and item master.
          </p>
        </div>

        <Tabs defaultValue="shops" className="w-full">
          <TabsList className="w-full max-w-md grid grid-cols-2">
            <TabsTrigger value="shops">Manage Shops</TabsTrigger>
            <TabsTrigger value="materials">Item Master</TabsTrigger>
          </TabsList>

          {/* ================= SHOPS ================= */}
          <TabsContent value="shops" className="space-y-4 mt-4">
            <Card>
              <CardContent className="space-y-4 pt-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">

                  {/* ORIGINAL FIELDS */}
                  <div className="space-y-2">
                    <Label>Shop Name</Label>
                    <Input
                      value={newShop.name}
                      onChange={e => setNewShop({ ...newShop, name: e.target.value })}
                      placeholder="e.g. City Hardware"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Location</Label>
                    <Input
                      value={newShop.location}
                      onChange={e => setNewShop({ ...newShop, location: e.target.value })}
                      placeholder="e.g. Downtown"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Phone</Label>
                    <Input
                      value={newShop.phone}
                      onChange={e => setNewShop({ ...newShop, phone: e.target.value })}
                      placeholder="Contact Number"
                    />
                  </div>

                  {/* ONLY ADDED */}
                  <div className="space-y-2">
                    <Label>City</Label>
                    <Input value={newShop.city}
                      onChange={e => setNewShop({ ...newShop, city: e.target.value })}/>
                  </div>
                  <div className="space-y-2">
                    <Label>State</Label>
                    <Input value={newShop.state}
                      onChange={e => setNewShop({ ...newShop, state: e.target.value })}/>
                  </div>
                  <div className="space-y-2">
                    <Label>Country</Label>
                    <Input value={newShop.country}
                      onChange={e => setNewShop({ ...newShop, country: e.target.value })}/>
                  </div>
                  <div className="space-y-2">
                    <Label>Pincode</Label>
                    <Input value={newShop.pincode}
                      onChange={e => setNewShop({ ...newShop, pincode: e.target.value })}/>
                  </div>

                </div>

                <Button onClick={handleAddShop} className="w-full md:w-auto">
                  <Plus className="mr-2 h-4 w-4" /> Add Shop
                </Button>
              </CardContent>
            </Card>

            <div className="grid gap-4 md:grid-cols-2">
              {shops.map(shop => (
                <Card key={shop.id}>
                  <CardContent className="flex flex-row items-center justify-between p-6">
                    <div>
                      <h3 className="text-lg font-bold flex items-center gap-2">
                        <Building2 className="h-4 w-4" /> {shop.name}
                      </h3>
                      <div className="text-sm text-muted-foreground">
                        {shop.location}, {shop.city}, {shop.country} • {shop.pincode}
                      </div>
                    </div>
                    <Button variant="ghost" size="icon" className="text-destructive">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </CardContent>
                </Card>
              ))}
            </div>
          </TabsContent>

          {/* ================= MATERIALS ================= */}

          <TabsContent value="materials" className="space-y-4 mt-4">
            <Card>
              <CardContent className="space-y-4 pt-6">

                {/* ORIGINAL MATERIAL GRID */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                  {/* ORIGINAL INPUTS UNTOUCHED */}
                  <div className="space-y-2">
                    <Label>Item Name</Label>
                    <Input value={newMaterial.name}
                      onChange={e => setNewMaterial({ ...newMaterial, name: e.target.value })}
                      placeholder="Item Name"/>
                  </div>

                  <div className="space-y-2">
                    <Label>Item Code</Label>
                    <Input value={newMaterial.code}
                      onChange={e => setNewMaterial({ ...newMaterial, code: e.target.value })}
                      placeholder="SKU / Code"/>
                  </div>

                  <div className="space-y-2">
                    <Label>Rate (₹)</Label>
                    <Input type="number" value={newMaterial.rate}
                      onChange={e => setNewMaterial({ ...newMaterial, rate: e.target.value })}
                      placeholder="0.00"/>
                  </div>

                  {/* ONLY ADDED FIELDS BELOW */}
                  <div className="space-y-2">
                    <Label>Brand Name</Label>
                    <Input value={newMaterial.brandName}
                      onChange={e => setNewMaterial({ ...newMaterial, brandName: e.target.value })}/>
                  </div>

                  <div className="space-y-2">
                    <Label>Model Number</Label>
                    <Input value={newMaterial.modelNumber}
                      onChange={e => setNewMaterial({ ...newMaterial, modelNumber: e.target.value })}/>
                  </div>

                  <div className="space-y-2">
                    <Label>Unit</Label>
                    <select
  className="flex h-10 w-full rounded-md border border-input bg-background text-foreground px-3 py-2 text-sm"
  value={newMaterial.unit}
  onChange={e => setNewMaterial({ ...newMaterial, unit: e.target.value })}
>
  {UNIT_OPTIONS.map(u => (
    <option key={u} className="bg-background text-foreground">
      {u}
    </option>
  ))}
</select>

                  </div>

                  <div className="space-y-2">
                    <Label>Category</Label>
                    <select
    className="flex h-10 w-full rounded-md border border-input bg-background text-foreground px-3 py-2 text-sm"
  value={newMaterial.category}
  onChange={e => setNewMaterial({ ...newMaterial, category: e.target.value })}
>
  {CATEGORY_OPTIONS.map(c => (
    <option key={c} className="bg-background text-foreground">
      {c}
    </option>
  ))}
</select>

                  </div>

                  <div className="space-y-2">
                    <Label>Sub Category</Label>
                    <select
  className="flex h-10 w-full rounded-md border border-input bg-background text-foreground px-3 py-2 text-sm"
  value={newMaterial.subCategory}
  onChange={e => setNewMaterial({ ...newMaterial, subCategory: e.target.value })}
>
  <option value="" className="bg-background text-foreground">
    Select
  </option>
  {SUB_CATEGORY_OPTIONS[newMaterial.category]?.map(sc => (
    <option key={sc} className="bg-background text-foreground">
      {sc}
    </option>
  ))}
</select>

                  </div>

                  <div className="space-y-2">
                    <Label>Supplier</Label>
                    <select
  className="flex h-10 w-full rounded-md border border-input bg-background text-foreground px-3 py-2 text-sm"
  value={newMaterial.shopId}
  onChange={e => setNewMaterial({ ...newMaterial, shopId: e.target.value })}
>
  <option value="" className="bg-background text-foreground">
    Select Shop
  </option>
  {shops.map(s => (
    <option key={s.id} value={s.id} className="bg-background text-foreground">
      {s.name} – {s.location}, {s.city}, {s.country} ({s.pincode})
    </option>
  ))}
</select>

                  </div>

                </div>

                <div className="space-y-2">
                  <Label>Technical Specification</Label>
                  <textarea
                    className="w-full rounded-md border p-2 text-sm"
                    rows={4}
                    value={newMaterial.technicalSpecification}
                    onChange={e => setNewMaterial({ ...newMaterial, technicalSpecification: e.target.value })}
                  />
                </div>

                <div className="space-y-2">
                  <Label>Product Image</Label>
                  <Input type="file" accept="image/*"
                    onChange={e => setNewMaterial({ ...newMaterial, image: e.target.files?.[0] || null })}/>
                </div>

                <Button onClick={handleAddMaterial} className="w-full md:w-auto">
                  <Plus className="mr-2 h-4 w-4" /> Add Material
                </Button>


                <Card>
  <CardContent className="p-0">
    <div className="rounded-md">
      <div className="grid grid-cols-12 bg-muted p-3 text-sm font-medium">
        <div className="col-span-4">Item Name</div>
        <div className="col-span-2">Code</div>
        <div className="col-span-2">Category</div>
        <div className="col-span-2">Rate</div>
        <div className="col-span-2 text-right">Action</div>
      </div>

      {materials.length === 0 && (
        <div className="p-4 text-sm text-muted-foreground">
          No materials added yet
        </div>
      )}

      {materials.map(mat => (
        <div
          key={mat.id}
          className="grid grid-cols-12 p-3 border-t text-sm items-center hover:bg-muted/10"
        >
          <div className="col-span-4 font-medium">{mat.name}</div>
          <div className="col-span-2 text-muted-foreground">{mat.code}</div>
          <div className="col-span-2 text-xs bg-secondary/50 rounded px-2 py-1 w-fit">
            {mat.category}
          </div>
          <div className="col-span-2">
            ₹{mat.rate} / {mat.unit}
          </div>
          <div className="col-span-2 text-right">
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8 text-destructive"
            >
              <Trash2 className="h-4 w-4" />
            </Button>
          </div>
        </div>
      ))}
    </div>
  </CardContent>
</Card>


              </CardContent>
            </Card>
          </TabsContent>

        </Tabs>
      </div>
    </Layout>
  );
}